SELECT
    so.name AS sale_order_name,
    so.state AS order_state,
    
    rp.partner_code AS partner_code,
    rp.name AS partner_name,
    rp.vat AS customer_tin,
    
    COALESCE(pd."productWarehouseId", fallback_pd."productWarehouseId") AS product_warehouse_code,
    pt.name AS product_name,
    pu.name AS uom_name,
    pt.is_excisable AS is_excisable,
    sol.product_pack AS sale_uom_qty,
    sol.product_uom_qty,
    sol.price_unit,
    sol.price_subtotal AS line_subtotal,

    so.amount_untaxed AS subtotal,
    so.amount_tax AS tax,
    so.amount_total AS total

FROM sale_order so
JOIN sale_order_line sol ON sol.order_id = so.id
JOIN res_partner rp ON rp.id = so.partner_id
JOIN product_product pp ON pp.id = sol.product_id
JOIN product_template pt ON pt.id = pp.product_tmpl_id
LEFT JOIN product_uom pu ON pu.id = pt.uom_sale_id
LEFT JOIN product_descriptor pd 
    ON pd.product_temp = pt.id AND pd.warehouse_id = so.warehouse_id
LEFT JOIN LATERAL (
    SELECT "productWarehouseId"
    FROM product_descriptor
    WHERE product_temp = pt.id
    ORDER BY id ASC
    LIMIT 1
) fallback_pd ON TRUE

WHERE so.name = 
ORDER BY sol.id;
